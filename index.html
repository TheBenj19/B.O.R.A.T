<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tradeoak Beam Calculator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f5f4e1; /* Cream color */
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            color: #333333; /* Darker text for contrast */
        }

        #volume-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #1A1A1A;
            color: #FFFFFF;
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            max-width: 300px;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        #volume-display button {
            margin-top: 10px;
            margin-right: 10px;
            padding: 8px 12px;
            font-size: 14px;
            font-family: 'Roboto', Arial, sans-serif;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: #FFFFFF;
            transition: background 0.3s ease;
        }

        #volume-display button:hover {
            background: #45A049;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1A1A1A;
            color: #FFFFFF;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            max-width: 300px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        #info a {
            color: #4CAF50;
            text-decoration: none;
        }

        #info a:hover {
            text-decoration: underline;
        }

        .label {
            margin-left: 8px;
            font-weight: 700;
            color: #4CAF50;
        }

        /* Style lil-gui to match Tradeoak */
        .lil-gui {
            font-family: 'Roboto', Arial, sans-serif !important;
            background: #1A1A1A !important;
            color: #FFFFFF !important;
            margin-top: 20px !important; /* Padding above controls */
        }

        .lil-gui .title {
            background: #4CAF50 !important;
            color: #FFFFFF !important;
            font-weight: 700 !important;
        }

        .lil-gui .controller {
            background: #2A2A2A !important;
            color: #FFFFFF !important;
        }

        .lil-gui input, .lil-gui select {
            background: #333333 !important;
            color: #FFFFFF !important;
            border: 1px solid #4CAF50 !important;
        }

        .lil-gui input:focus, .lil-gui select:focus {
            outline: none !important;
            border-color: #45A049 !important;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #volume-display {
                top: 10px;
                left: 10px;
                font-size: 14px;
                max-width: 200px;
                padding: 10px;
            }

            #volume-display button {
                padding: 6px 10px;
                font-size: 12px;
            }

            #info {
                top: 10px;
                font-size: 14px;
                padding: 8px 12px;
            }

            .lil-gui {
                font-size: 14px !important;
                width: 200px !important;
                margin-top: 60px !important; /* Consistent padding for mobile */
            }
        }
    </style>
</head>
<body>
    <div id="info">
        Ben's Oustanding Revolutionary Application for Tradeoak
    </div>
    <div id="volume-display">
        <span id="volume-text">Calculating volume...</span><br />
        <div id="dimension-labels"></div>
        <button id="reset-btn" aria-label="Reset dimensions to default">Reset</button>
        <button id="export-btn" aria-label="Export dimensions and cost to PDF">Export</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { GUI } from 'lil-gui';
        import WebGPURenderer from 'three/addons/renderers/webgpu/WebGPURenderer.js';

        let camera, scene, renderer, controls;
        let model, gui;
        let originalVolume = 0;
        let originalDimensions;
        
        let params;

        const MATERIAL_COSTS = {
            'Green Oak (D24)': 2880,
            'Green Oak (D30)': 3000,
            'Softwood': 1750,
            'Kiln Dried Oak': 3500
        };

        // NEW: Added cost multipliers for different finishes
        const FINISH_COST_MULTIPLIERS = {
            'Sawn': 1.0,      // Base price
            'Planned': 1.15,  // 15% cost increase
            'Machined': 1.30  // 30% cost increase
        };

        const DEFAULT_DIMENSIONS = {
            width: 20,
            height: 20,
            length: 1000
        };

        const DEFAULT_MATERIAL = 'Green Oak (D24)';
        const DEFAULT_QUANTITY = 1;
        const DEFAULT_FINISH = 'Sawn';

        init();

        function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 20);
            camera.position.set(-0.75, 0.7, 3);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f4e1);

            renderer = new WebGPURenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            renderer.setAnimationLoop(animate);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.35, 0);
            controls.update();

            new RGBELoader()
                .setPath('textures/equirectangular/')
                .load('royal_esplanade_1k.hdr', (hdr) => {
                    hdr.mapping = THREE.EquirectangularReflectionMapping;
                    scene.environment = hdr;
                });

            loadModel();

            window.addEventListener('resize', onWindowResize);

            document.getElementById('reset-btn').onclick = () => {
                if (!model || !gui) return;
                resetDimensions();
            };

            document.getElementById('export-btn').onclick = () => {
                const calcs = getCalculations();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('Beam Specifications', 20, 20);

                doc.setFontSize(14);
                doc.text('Per Item', 20, 35);
                doc.setFontSize(12);
                doc.text(`Material: ${calcs.material}`, 20, 45);
                // MODIFIED: Added Finish to PDF and adjusted Y-positions
                doc.text(`Finish: ${calcs.finish}`, 20, 52);
                doc.text(`Width: ${Math.round(calcs.width)} mm`, 20, 59);
                doc.text(`Height: ${Math.round(calcs.height)} mm`, 20, 66);
                doc.text(`Length: ${Math.round(calcs.length)} mm`, 20, 73);
                doc.text(`Volume: ${calcs.singleVolume.toFixed(4)} m³`, 20, 80);
                doc.text(`Cost: £${calcs.singleCost.toFixed(2)}`, 20, 87);

                doc.setFontSize(14);
                doc.text('Totals', 20, 102);
                doc.setFontSize(12);
                doc.text(`Quantity: ${calcs.quantity}`, 20, 112);
                doc.text(`Total Linear Meters: ${calcs.totalLinearMeters.toFixed(2)} m`, 20, 119);
                doc.text(`Total Volume: ${calcs.totalVolume.toFixed(3)} m³`, 20, 126);
                doc.text(`Total Cost: £${calcs.totalCost.toFixed(2)}`, 20, 133);
                
                doc.setFontSize(10);
                doc.text('Generated by Tradeoak Beam Visualizer', 20, 149);

                doc.save('beam_specifications.pdf');
            };
        }

        function loadModel() {
            const textureLoader = new THREE.TextureLoader();
            const oakTexture = textureLoader.load('textures/equirectangular/Oak.png');
            oakTexture.mapping = THREE.UVMapping;
            oakTexture.wrapS = THREE.RepeatWrapping;
            oakTexture.wrapT = THREE.RepeatWrapping;
            oakTexture.repeat.set(1, 1);
            oakTexture.rotation = Math.PI / 2;

            new GLTFLoader()
                .setPath('models/gltf/')
                .load('beam.glb', (gltf) => {
                    model = gltf.scene;
                    scene.add(model);

                    model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            child.material = new THREE.MeshStandardMaterial({
                                map: oakTexture,
                                roughness: 0.7,
                                metalness: 0.0,
                                side: THREE.DoubleSide
                            });
                            child.material.needsUpdate = true;
                        }
                    });

                    const bbox = new THREE.Box3().setFromObject(model);
                    originalDimensions = {
                        width: (bbox.max.x - bbox.min.x) / 2,
                        height: (bbox.max.y - bbox.min.y) / 2,
                        depth: (bbox.max.z - bbox.min.z) / 2
                    };

                    originalVolume = calculateModelVolume(model) * 0.125;

                    setupGUI();
                    resetDimensions();
                }, undefined, (error) => {
                    console.error(error);
                    document.getElementById('volume-text').textContent = 'Error loading model';
                });
        }

        function setupGUI() {
            gui = new GUI();

            params = {
                width: DEFAULT_DIMENSIONS.width,
                height: DEFAULT_DIMENSIONS.height,
                length: DEFAULT_DIMENSIONS.length,
                material: DEFAULT_MATERIAL,
                finish: DEFAULT_FINISH, // NEW
                quantity: DEFAULT_QUANTITY
            };

            const dimFolder = gui.addFolder('Dimensions (mm)');
            dimFolder.add(params, 'width', 20, 400).step(1).name('Width (mm)').onChange(updateVolumeDisplay);
            dimFolder.add(params, 'height', 20, 400).step(1).name('Height (mm)').onChange(updateVolumeDisplay);
            dimFolder.add(params, 'length', 100, 9000).step(1).name('Length (mm)').onChange(updateVolumeDisplay);
            dimFolder.open();
            
            const matFolder = gui.addFolder('Material');
            matFolder.add(params, 'material', Object.keys(MATERIAL_COSTS)).name('Material').onChange(updateVolumeDisplay);
            matFolder.open();

            // NEW: Finish controller
            const finishFolder = gui.addFolder('Finish');
            finishFolder.add(params, 'finish', Object.keys(FINISH_COST_MULTIPLIERS)).name('Finish').onChange(updateVolumeDisplay);
            finishFolder.open();

            const qtyFolder = gui.addFolder('Quantity');
            qtyFolder.add(params, 'quantity', 1, 100).step(1).name('Quantity').onChange(updateVolumeDisplay);
            qtyFolder.open();
        }

        function resetDimensions() {
            params.width = DEFAULT_DIMENSIONS.width;
            params.height = DEFAULT_DIMENSIONS.height;
            params.length = DEFAULT_DIMENSIONS.length;
            params.material = DEFAULT_MATERIAL;
            params.finish = DEFAULT_FINISH; // NEW
            params.quantity = DEFAULT_QUANTITY;

            gui.controllers.forEach(c => c.updateDisplay());
            
            updateVolumeDisplay();
        }

        function calculateModelVolume(model) {
            let total = 0;
            model.traverse((child) => {
                if (child.isMesh && child.geometry) {
                    const geometry = child.geometry.clone();
                    geometry.computeBoundingBox();
                    const scaledVolume = calculateGeometryVolume(geometry) *
                        child.scale.x * child.scale.y * child.scale.z;
                    total += scaledVolume;
                }
            });
            return Math.abs(total);
        }

        function calculateGeometryVolume(geometry) {
            if (!geometry.index) geometry = geometry.toNonIndexed();
            const pos = geometry.attributes.position.array;
            const idx = geometry.index.array;
            let vol = 0;

            for (let i = 0; i < idx.length; i += 3) {
                const a = idx[i] * 3, b = idx[i + 1] * 3, c = idx[i + 2] * 3;
                const p0 = new THREE.Vector3(pos[a], pos[a + 1], pos[a + 2]);
                const p1 = new THREE.Vector3(pos[b], pos[b + 1], pos[b + 2]);
                const p2 = new THREE.Vector3(pos[c], pos[c + 1], pos[c + 2]);
                vol += p0.dot(p1.cross(p2)) / 6;
            }
            return Math.abs(vol);
        }

        function getCalculations() {
            if (model && originalDimensions) {
                model.scale.x = (params.width / 1000) / originalDimensions.width;
                model.scale.y = (params.height / 1000) / originalDimensions.height;
                model.scale.z = (params.length / 1000) / originalDimensions.depth;
            }

            const singleVolume = originalVolume * model.scale.x * model.scale.y * model.scale.z;
            
            // MODIFIED: Cost calculation now includes the finish multiplier
            const materialCost = MATERIAL_COSTS[params.material];
            const finishMultiplier = FINISH_COST_MULTIPLIERS[params.finish];
            const singleCost = singleVolume * materialCost * finishMultiplier;

            const totalVolume = singleVolume * params.quantity;
            const totalCost = singleCost * params.quantity;
            const totalLinearMeters = (params.length / 1000) * params.quantity;

            return {
                width: params.width,
                height: params.height,
                length: params.length,
                material: params.material,
                finish: params.finish, // NEW
                quantity: params.quantity,
                singleVolume,
                singleCost,
                totalVolume,
                totalCost,
                totalLinearMeters
            };
        }

        function updateVolumeDisplay() {
            if (!model) return;
            
            const calcs = getCalculations();
            const text = document.getElementById('volume-text');
            const labels = document.getElementById('dimension-labels');

            text.innerHTML = `Total Cost: £${calcs.totalCost.toFixed(2)}<br>` +
                             `Total Volume: ${calcs.totalVolume.toFixed(3)} m³`;

            // MODIFIED: Added Finish to the display labels
            labels.innerHTML =
                `Quantity: <span class="label">${calcs.quantity}</span><br>` +
                `Material: <span class="label">${calcs.material}</span><br>` +
                `Finish: <span class="label">${calcs.finish}</span><br>` +
                `Width: <span class="label">${Math.round(calcs.width)} mm</span><br>` +
                `Height: <span class="label">${Math.round(calcs.height)} mm</span><br>` +
                `Length: <span class="label">${Math.round(calcs.length)} mm</span>`;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
